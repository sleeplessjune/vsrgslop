extends Node2D

@onready var mvplayer: VideoStreamPlayer = $"../mvplayer"

const in_editor: bool = false
var song_name = "OVERJOY OVERDOSE"


var scroll_speed: float = -1.45
var note_output_arr = [[], [], [], []]


var song_info = {
	"OVERJOY OVERDOSE" = {
		"note_spawn_times": "[[3.500113, 4.333046, 5.483286, 5.983007, 6.916389, 8.399585, 9.0829, 10.332731, 10.982801, 11.399907, 11.832904, 12.466706, 12.883404, 13.282775, 13.682599, 14.132644, 15.21591, 16.099189, 17.765809, 19.149179, 20.065711, 21.115833, 21.849907, 24.232289, 25.165552, 25.948861, 26.332135, 28.4154219999999, 30.1152899999999, 30.9986709999999, 32.6152949999999, 34.1319459999999, 35.182215, 37.23175, 38.748309, 39.381757, 39.7985079999999, 42.664953, 42.914893, 44.3990409999999, 45.4313819999999, 46.7146549999999, 47.9479159999999, 49.5647399999999, 50.7312919999999, 51.747784, 52.1477909999999, 52.347912, 52.547814, 53.447811, 54.2978099999999, 54.897742, 56.064269, 57.214299, 58.298331, 58.68084, 58.897579, 60.047533, 61.830737, 62.230931, 63.9139829999999, 67.297262, 67.763889, 69.747088, 70.597638, 73.0637320000002, 73.4302870000001, 77.1968870000001, 79.0634720000002, 79.4466550000002, 82.7799560000003, 84.0298260000003, 85.3132040000003, 86.3297900000003, 87.4130710000004, 88.6962960000003, 90.9296910000003, 93.9961460000002, 94.4627700000002, 94.7795120000002, 95.0961630000002, 95.4461020000002, 96.2626520000002, 97.1127070000002, 100.595917, 101.062556, 101.91243, 102.962472, 103.395811, 104.412317, 105.047163, 105.845604, 106.112346, 106.545734, 108.145598, 109.245548, 110.678927, 112.595372, 113.862088, 116.36192, 116.778503, 117.446278, 117.962184, 118.261979, 118.528535, 119.245337, 120.111727, 121.295435, 122.245295, 123.462411, 123.546149, 124.511889, 125.394862, 126.561773, 127.478244, 127.694885, 128.978135, 129.361712, 130.244787, 132.395181, 132.646677, 133.328004, 133.744623000001, 134.177822, 136.544555, 137.778077000001, 138.194522000001, 140.695381, 141.161034, 141.52773, 141.927649, 144.360848, 146.760797000001, 148.477477000001, 150.644038000001], [3.483059, 4.916432, 6.000178, 6.632991, 7.249663, 7.482965, 7.699562, 8.849594, 9.349563, 10.549403, 10.749706, 11.183823, 11.60191, 12.032693, 12.232742, 12.666086, 13.082932, 13.500579, 13.89936, 14.333334, 16.099189, 17.165909, 18.465897, 19.399151, 20.449167, 21.649089, 22.349013, 23.415596, 24.69903, 25.548892, 25.965798, 26.716059, 27.3487969999999, 28.015459, 29.0820779999999, 29.2654509999999, 30.5485949999999, 31.8668439999999, 32.8653319999999, 33.8819129999999, 34.315129, 34.748527, 35.498561, 36.848865, 37.698432, 38.131665, 38.5828, 39.182155, 39.7985079999999, 40.1984979999999, 40.766251, 42.064918, 42.914893, 43.5316119999999, 44.7981879999999, 44.9980459999999, 46.0489549999999, 46.498043, 47.1323399999999, 47.4479359999999, 48.2478779999999, 48.6313039999999, 48.8313789999999, 49.8813529999999, 50.2977919999999, 51.1478429999999, 51.3312409999999, 52.5648429999999, 52.9148429999999, 53.231248, 53.7477349999999, 54.0810919999999, 54.5819999999999, 55.3309839999999, 56.147745, 56.564338, 57.564623, 57.89803, 58.68084, 58.897579, 59.714266, 60.330999, 60.830828, 61.180954, 61.431319, 62.248265, 63.2809139999999, 63.5307749999999, 64.2313269999999, 64.5308009999999, 65.680946, 65.881122, 67.031199, 67.147241, 67.480625, 68.847123, 69.513743, 70.063776, 71.4136370000001, 72.5637430000001, 73.1805830000001, 73.8469730000001, 74.7303180000002, 76.2802230000001, 76.4968420000001, 76.8634720000001, 77.3803870000002, 78.0968750000002, 78.4302110000002, 78.6133540000002, 79.2634240000002, 80.1800070000002, 80.4800940000002, 81.5300560000003, 81.7632800000003, 82.0965760000003, 82.3966690000002, 83.6464620000003, 84.2464470000003, 84.7297910000003, 85.7130530000003, 86.9798750000004, 87.7463460000004, 88.2963090000003, 89.1296230000003, 90.5629690000003, 91.3796280000003, 92.7462170000002, 92.9962640000003, 93.7961650000002, 94.1795910000002, 94.5961150000002, 94.9628330000003, 95.3627720000002, 96.2626520000002, 96.8793140000002, 97.3293710000002, 97.5960390000002, 97.8960500000002, 98.2293760000002, 98.7626670000002, 99.3461690000002, 99.6292230000002, 99.8299160000002, 100.380257, 100.78026, 101.312623, 101.595916, 102.329253, 102.529152, 103.195816, 103.879043, 104.095824, 104.729064, 105.462386, 106.179011, 106.545734, 107.162315, 107.945649, 109.062262, 109.662244, 110.378905, 111.078846, 111.345532, 111.781034, 112.195513, 112.928682, 113.478722, 114.245271, 114.728658, 115.561978, 115.945223, 116.778503, 117.128495, 117.661997, 118.062124, 118.461835, 118.845046, 119.578481, 119.911802, 120.111727, 121.028996, 121.711735, 123.028299, 123.445069, 124.094904, 125.014509, 125.713344, 125.911513, 126.861541, 127.694885, 128.094961, 128.528029, 129.361712, 129.794761000001, 130.244787, 130.811282, 131.244745, 131.678474, 132.09482, 132.628016, 132.944651, 133.394767, 133.794588, 134.195269, 134.811252000001, 135.078072000001, 135.477910000001, 135.928137000001, 136.645377000001, 136.961502, 137.377661000001, 137.994533000001, 138.227856000001, 138.477728000001, 138.877956000001, 139.145605, 139.344515, 140.077725, 140.695381, 141.010984, 141.3277, 141.744268, 142.344369, 142.794238, 144.160929, 145.010823, 145.794200000001, 145.994235, 146.360875000001, 146.760797000001, 148.260739000001, 148.477477000001, 148.894140000001, 149.510775000001, 149.927382000001, 150.843810000001], [2.56649, 4.066558, 5.766288, 6.816273, 7.366265, 7.833187, 8.532854, 9.766265, 10.433622, 10.866156, 11.116139, 11.316101, 11.516163, 11.716114, 12.14938, 12.549475, 12.799424, 13.40036, 13.832583, 14.315959, 15.665983, 16.832831, 18.282519, 18.382552, 18.81584, 19.91582, 20.799067, 21.750004, 22.799011, 23.199001, 23.332732, 23.849007, 25.048983, 26.298766, 26.698837, 27.6156759999999, 28.015459, 28.8322229999999, 29.1987249999999, 29.4654699999999, 29.9153539999999, 30.7653659999999, 31.7485949999999, 32.2152539999999, 32.6652379999999, 33.6987389999999, 34.965197, 35.38201, 36.215231, 36.648513, 37.481749, 38.315025, 38.464942, 39.048549, 40.548282, 41.4148399999999, 41.864922, 42.481518, 43.3314809999999, 44.1816269999999, 44.8984189999999, 45.8647019999999, 46.5981459999999, 46.914698, 47.7980049999999, 48.0646309999999, 48.7157589999999, 49.6812639999999, 50.5152829999999, 51.2482719999999, 51.9478579999999, 52.814455, 52.9812009999999, 53.63114, 54.1819369999999, 54.6648789999999, 55.5143919999999, 55.9810639999999, 56.314387, 56.9811249999999, 57.747552, 58.464267, 59.564194, 60.230827, 60.964057, 61.647603, 63.047389, 63.6806859999999, 64.1306689999999, 64.7139299999999, 65.130656, 65.547364, 65.780636, 65.997233, 66.830626, 66.947174, 67.447175, 67.630721, 68.730609, 69.397141, 69.614094, 70.446994, 71.4970100000001, 72.7136120000001, 72.8636740000001, 74.6137250000002, 74.8305330000001, 76.0803470000001, 76.2134880000001, 76.7469380000001, 76.9803930000001, 77.9806780000002, 78.5302710000002, 80.0967620000002, 80.6967540000002, 81.6300470000003, 82.1799880000002, 83.8132770000003, 85.1131960000003, 86.0131340000003, 87.1798510000004, 87.6297230000004, 88.4963060000003, 89.2964120000003, 90.1629500000003, 90.3629140000003, 90.7629530000003, 91.0629600000003, 91.2128360000003, 91.8629490000003, 92.0628730000003, 92.2462790000003, 92.8462670000002, 93.1134500000003, 93.8802540000002, 94.3627600000003, 94.6299230000002, 95.7795850000002, 96.6794110000002, 97.2293180000002, 97.4298990000002, 98.0128010000002, 98.6292140000002, 99.4292650000002, 100.012581, 100.495921, 100.67959, 100.979416, 101.412803, 102.096035, 103.779104, 104.279102, 104.945736, 105.262385, 105.695814, 105.912356, 106.945564, 107.745629, 108.61228, 110.062161, 110.47889, 111.128865, 111.695483, 112.095347, 112.428794, 112.828663, 113.761997, 114.578798, 114.945477, 116.228573, 116.561818, 117.229122, 117.661997, 118.479044, 119.295081, 120.111727, 120.945246, 121.711735, 122.42831, 123.878398, 124.761989, 125.194814, 125.828393, 126.646084, 127.694885, 128.311368, 128.528029, 128.744998, 129.161386, 129.379242, 129.52817, 130.244787, 130.628161, 131.478234, 131.928164, 132.328137, 132.544702, 133.14454, 134.644633000001, 135.044836000001, 135.477910000001, 135.877950000001, 136.327851000001, 136.944369, 137.577754000001, 138.661139000001, 139.261070000001, 139.961042, 140.677693, 141.94492, 142.161297, 142.89426, 143.660907, 144.044211, 144.294224, 145.344046, 145.577536000001, 146.094992000001, 147.227600000001, 147.644093000001, 149.277199000001, 150.144061000001], [3.200077, 5.116424, 6.382995, 7.049632, 7.599629, 10.199765, 10.649504, 11.932866, 12.366038, 13.016041, 13.199674, 13.616145, 14.065978, 15.683229, 17.465986, 18.565928, 19.215744, 20.182434, 21.299001, 21.53243, 22.09898, 22.799011, 23.532669, 24.515556, 25.282174, 27.1487619999999, 27.6156759999999, 28.4154219999999, 29.1321709999999, 30.2988309999999, 31.1823849999999, 31.4320569999999, 31.5819399999999, 31.9486129999999, 33.2652759999999, 33.4485939999999, 34.531916, 35.815112, 36.215231, 37.048498, 37.898469, 41.015094, 41.4148399999999, 41.864922, 43.7816839999999, 44.5816589999999, 45.2148319999999, 46.2647029999999, 47.3312699999999, 48.3993049999999, 49.4478829999999, 50.0978729999999, 50.9145889999999, 51.5482379999999, 53.3478049999999, 53.864378, 54.4811689999999, 55.0976369999999, 55.9309879999999, 56.681044, 57.447617, 58.098111, 59.930862, 60.547519, 61.314034, 62.014097, 63.3818069999999, 64.4140749999999, 66.447327, 66.647325, 68.963878, 71.2969790000001, 72.2804310000001, 72.3970350000001, 75.6134620000001, 75.7803720000001, 76.4135840000001, 78.2134620000002, 78.8133540000002, 80.2810100000002, 81.1967060000003, 81.3465650000003, 81.8806150000003, 82.6132780000002, 83.4465960000002, 85.5131270000003, 86.7464690000004, 88.0796570000004, 88.9129960000003, 91.5300130000003, 92.4462670000003, 92.5962300000003, 93.4461940000002, 93.6795240000002, 94.0968230000002, 96.9960890000002, 97.7125870000002, 98.3133010000002, 99.0125210000002, 99.1960490000002, 99.7291880000002, 100.279285, 101.679603, 102.429162, 102.74605, 103.979196, 104.628976, 106.280722, 107.362238, 107.745629, 108.61228, 110.062161, 110.828981, 111.612051, 112.095347, 112.445754, 113.245437, 114.045322, 114.578798, 114.945477, 115.728605, 116.245735, 117.229122, 119.645828, 121.161962, 122.061659, 122.828305, 124.294979, 124.761989, 125.611669, 126.211587, 127.295012, 127.911534, 128.528029, 130.244787, 131.011635, 131.478234, 135.044836000001, 135.477910000001, 135.877950000001, 136.627843000001, 137.344329000001, 139.044443, 139.644426, 140.294222, 142.577629, 143.244179, 143.660907, 144.627384, 145.878415000001, 146.527513000001, 148.061041000001, 149.727323000001]]
"
	}
}

func _ready():
	if in_editor:
		Global.NoteReceptorPress.connect(NoteReceptorPress)
	else:
		var note_spawn_times = song_info.get(song_name).get("note_spawn_times")
		var note_spawn_times_arr = str_to_var(note_spawn_times)
		
		var counter: int = 0
		for key in note_spawn_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "key_d"
				1:
					button_name = "key_f"
				2:
					button_name = "key_j"
				3:
					button_name = "key_k"
			
			for delay in key:
				SpawnNote(button_name, delay)
				
			counter += 1

func NoteReceptorPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str(mvplayer.get_stream_position()))
	note_output_arr[array_num].append(mvplayer.get_stream_position() - scroll_speed)


func SpawnNote(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Global.CreateNote.emit(button_name)

func _on_mvplayer_finished():
	print(note_output_arr)
	mvplayer.queue_free()
	get_tree().change_scene_to_file("res://scenes/results_screen.tscn")
